<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <!--<link rel="apple-touch-icon" sizes="76x76" href="assets/img/apple-icon.png">
    <link rel="icon" type="image/png" href="assets/img/favicon.png">-->
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title data-i18n="ews.pageTitle" id="pageTitle">
    </title>
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no' name='viewport' />
    <!--     Fonts and icons     -->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700,200" rel="stylesheet" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.1/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
    <!-- CSS Files -->
    <link href="assets/css/bootstrap.min.css" rel="stylesheet" />
    <link href="assets/css/now-ui-dashboard.min.css?v=1.4.0" rel="stylesheet" />
    <!--<link href="assets/css/adminlte.css" rel="stylesheet" />-->
    <link rel="stylesheet" href="assets/js/plugins/sweetalert2.min.css">
    <link rel="stylesheet" href="assets/css/fcs.css">
    <link rel="stylesheet" href="assets/js/plugins/daterangepicker.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" href="assets/js/plugins/nouislider.css" />
    <!--<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">-->
    <style>
        .modal-lg {
            /*//max-width: 60% !important;*/
            max-width: 1200px !important;
            max-height: 900px !important;
        }

        .chart-container {
            position: relative;
            margin: auto;
            height: 320px;
            width: 600px;
            /*height: 35vh;
            width: 30vw;*/
        }
    </style>
</head>

<body class="sidebar-mini" style="overflow:auto;">
    <div class="wrapper">
        <!--     side menu     -->
        <div class="sidebar" data-color="blue" id="fcsSideBar">
            <div class="logo">
                <a href="http://floodcitisense.webflow.io/" target="_blank" class="simple-text logo-mini"
                   data-i18n="sidemenu.fcs">
                </a>
                <a href="http://floodcitisense.webflow.io/" target="_blank" class="simple-text logo-normal"
                   data-i18n="sidemenu.floodCitiSense">
                </a>
                <div class="navbar-minimize">
                    <button id="minimizeSidebar" class="btn btn-simple btn-icon btn-neutral btn-round">
                        <i class="now-ui-icons text_align-center visible-on-sidebar-regular"></i>
                        <i class="now-ui-icons design_bullet-list-67 visible-on-sidebar-mini"></i>
                    </button>
                </div>
            </div>

            <div class="sidebar-wrapper" id="sidebar-wrapper">
                <div class="user d-none" id="FCSNavUser">
                    <div class="photo">
                        <img src="images/missingAvatar.png" />
                    </div>
                    <div class="info">
                        <a data-toggle="collapse" href="#collapseExample" class="collapsed">
                            <span>
                                <span id="fcsSidebarUserName" data-i18n="nav.account"></span>
                                <b class="caret"></b>
                            </span>
                        </a>
                        <div class="clearfix"></div>
                        <div class="collapse" id="collapseExample">
                            <ul class="nav">
                                <li>
                                    <a href="Profile.html">
                                        <span class="sidebar-mini-icon" data-i18n="sidemenu.editProfileAbbr"></span>
                                        <span class="sidebar-normal" data-i18n="sidemenu.editProfile"></span>
                                    </a>
                                </li>
                                <li>
                                    <a href="Pwd.html">
                                        <span class="sidebar-mini-icon" data-i18n="sidemenu.resetProfileAbbr"></span>
                                        <span class="sidebar-normal" data-i18n="sidemenu.resetProfile"></span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <ul class="nav" id="fcsSideMenu">
                    <!--<li>
                        <a href="Default.html">
                            <i class="fas fa-map-marked"></i>
                            <p data-i18n="sidemenu.rainfallSensors"></p>
                        </a>
                    </li>
                    <li>
                        <a href="Incident.html">
                            <i class="fas fa-cloud-rain"></i>
                            <p data-i18n="sidemenu.floodMenu1"></p>
                            <p style="padding-left:46px;" data-i18n="sidemenu.floodMenu2"></p>
                        </a>
                    </li>
                    <li class="active">
                        <a href="EWS.html">
                            <i class="fas fa-water"></i>
                            <p data-i18n="sidemenu.ews"></p>
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="openAboutDlg();">
                            <i class="fa fa-info-circle"></i>
                            <p data-i18n="sidemenu.about"></p>
                        </a>
                    </li>-->
                </ul>

            </div>
        </div>

        <div class="main-panel" id="main-panel">
            <nav class="navbar navbar-expand-lg navbar-transparent  bg-primary  navbar-absolute">
                <div class="container-fluid">
                    <div class="navbar-wrapper">
                        <div class="navbar-toggle">
                            <button type="button" class="navbar-toggler">
                                <span class="navbar-toggler-bar bar1"></span>
                                <span class="navbar-toggler-bar bar2"></span>
                                <span class="navbar-toggler-bar bar3"></span>
                            </button>
                        </div>
                        <a class="navbar-brand" href="http://floodcitisense.webflow.io/" target="_blank" data-i18n="sidemenu.floodCitiSense"></a>
                    </div>
                    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation" aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-bar navbar-kebab"></span>
                        <span class="navbar-toggler-bar navbar-kebab"></span>
                        <span class="navbar-toggler-bar navbar-kebab"></span>
                    </button>
                    <div class="collapse navbar-collapse justify-content-end" id="navigation">

                        <ul class="navbar-nav" id="fcsNav"></ul>
                        <ul class="navbar-nav">
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="http://example.com" id="dropdown09" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"> <i class="now-ui-icons location_world"></i> <span id="fcsCurrentLng">English</span></a>
                                <div class="dropdown-menu" aria-labelledby="dropdown09">
                                    <a class="dropdown-item" href="#" onclick="return changeLang('en'); return false;"><span data-i18n="lng.english"> </span></a>
                                    <a class="dropdown-item" href="#" onclick="return changeLang('fr'); return false;"><span data-i18n="lng.french"> </span></a>
                                    <a class="dropdown-item" href="#" onclick="return changeLang('nl'); return false;"><span data-i18n="lng.dutch"> </span></a>
                                    <a class="dropdown-item" href="#" onclick="return changeLang('el'); return false;"><span data-i18n="lng.greek"> </span></a>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>

            <div class="panel-header" style="height:100px;padding-top: 10px;padding-bottom: 10px;background:#00a99d">
            </div>

            <div class="content">
                <div class="row">
                    <div class="col-md-4" style="min-height:600px;" id="fcsTable">
                        <div class="card">
                            <div class="card-header" id="fcsTableHeader">
                                <div class="row">
                                    <label style="font-size:18px;padding-right:5px;" data-i18n="ews.table.title"></label>
                                    <select id="cboEwsType" class="selectpicker" data-width="35%" data-size="5" data-style="btn btn-info btn-round" title="">
                                        <option value="rotterdam"></option>
                                        <option value="brussels"></option>
                                        <option value="birmingham" selected="selected"></option>
                                    </select>
                                    <select id="cboEwsEvent" class="selectpicker" data-width="30%" data-size="5" data-style="btn btn-info btn-round" title="">
                                    </select>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="toolbar" id="fcsTableToolbar">
                                </div><!--class="table table-striped table-bordered"-->
                                <table id="maintable" class="display" cellspacing="0" width="100%">
                                    <thead>
                                        <tr style="font-size:12px;">
                                            <th data-i18n="ews.table.column.id"></th>
                                            <th data-i18n="ews.table.column.name"></th>
                                            <th data-i18n="sensor.table.column.action"></th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                    <tfoot>
                                        <tr style="font-size:12px;">
                                            <th data-i18n="ews.table.column.id"></th>
                                            <th data-i18n="ews.table.column.name"></th>
                                            <th data-i18n="sensor.table.column.action"></th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            <!-- end content-->
                            <div class="overlay" style="" id="loading_table">
                                <i class="fas fa-sync-alt fa-spin"></i>
                            </div>
                        </div><!--  end card  -->
                    </div>
                    <div class="col-md-8">
                        <!--<div id="map" style="position: absolute;width: 100%;left: 0;height:1000px;"></div>-->
                        <!--<div class="container-fluid" style="height:100%;">-->
                        <div class="row d-none" style="background-color:azure;" id="histryDiv">
                            <div class="chart-container col-11" style="height:200px;background-color:lightskyblue">
                                <canvas id="chartZoneNew" style="width:100%;height:100%;"></canvas>
                            </div>
                            <div style="padding:0px;margin:0px">
                                <button id="btnBack" class="btn btn-sm" onclick="openHistryDiv(false)">
                                    <i class="fas fa-times-circle"></i>
                                </button>
                            </div>
                            <div class="col-12 row" style="padding-top:10px;padding-bottom:5px;">
                                <div class="col-10" style="padding-left:20px;padding-right:10px;">
                                    <div id="sliderRegularNew" class="slider" style="width:100%;font-size:10px;"></div>
                                </div>
                                <div class="col-2 p-0 m-0">
                                    <button id="btnBack" class="btn btn-info btn-sm" onclick="goBack()">
                                        <i class="fas fa-backward"></i>
                                    </button>
                                    <button id="btnPlay" class="btn btn-info btn-sm visible" onclick="playProbability()">
                                        <i id="iconPlay" class="fas fa-play"></i>
                                    </button>
                                    <button id="btnNext" class="btn btn-info btn-sm" onclick="goNext()">
                                        <i class="fas fa-forward"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <!--<div class="container-fluid" style="height:100%;width:100%;position:absolute;top:0;padding:0;">-->
                            <div class="col-12 p-0 m-0">
                                <div id="map" style="min-height:600px;"></div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
        <div id="fcsFooter" style="padding:0;margin:0;"></div>
    </div>

    <div class="fixed-plugin" id="webPlugin">
        <div class="dropdown show-dropdown">
            <a href="#" data-toggle="dropdown">
                <i class="fas fa-layer-group fa-2x" style="color:white;padding-top:10px;padding-bottom:10px;"></i>
                <!--<i class="fa fa-cog fa-2x"> </i>-->
            </a>
            <ul class="dropdown-menu" style="width:180px;">
                <li class="adjustments-line" style="height:170px">
                    <a href="javascript:void(0)" class="switch-trigger">
                        <div class="card" style="margin:0px;padding:0px;">
                            <div class="card-header " style="margin:0px;padding:0px;">
                                <h5 class="card-title" style="color:black;" data-i18n="gmap.mapType"></h5>
                            </div>
                            <div class="card-body" style="margin:0px;padding:0px;">
                                <div class="form-check form-check-radio">
                                    <label class="form-check-label" style="width:150px;">
                                        <input class="form-check-input" type="radio" name="maptypeRadios" id="rdMaptype1" value="roadmap" checked>
                                        <span class="form-check-sign" data-i18n="gmap.type.roadmap"></span>
                                    </label>
                                    <label class="form-check-label" style="width:150px;">
                                        <input class="form-check-input" type="radio" name="maptypeRadios" id="rdMaptype2" value="satellite">
                                        <span class="form-check-sign" data-i18n="gmap.type.satellite"></span>
                                    </label>
                                    <label class="form-check-label" style="width:150px;">
                                        <input class="form-check-input" type="radio" name="maptypeRadios" id="rdMaptype3" value="hybrid">
                                        <span class="form-check-sign" data-i18n="gmap.type.hybrid"></span>
                                    </label>
                                    <label class="form-check-label" style="width:150px;">
                                        <input class="form-check-input" type="radio" name="maptypeRadios" id="rdMaptype4" value="terrain">
                                        <span class="form-check-sign" data-i18n="gmap.type.terrain"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </a>
                </li>
                &nbsp;
            </ul>
        </div>
    </div>
    <div id="fcsAbout" style="padding:0;margin:0;">

    </div>
    <!--   Core JS Files   -->
    <script src="assets/js/core/jquery.min.js"></script>
    <script src="assets/js/core/popper.min.js"></script>
    <script src="assets/js/core/bootstrap.min.js"></script>
    <script src="assets/js/plugins/perfect-scrollbar.jquery.min.js"></script>
    <!--	Plugin for Select, full documentation here: http://silviomoreto.github.io/bootstrap-select -->
    <!--<script src="assets/js/plugins/bootstrap-selectpicker.js"></script>-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
    <!-- (Optional) Latest compiled and minified JavaScript translation files -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/i18n/defaults-*.min.js"></script>
    <script src="assets/js/plugins/bootstrap-switch.js"></script>
    <!--  Notifications Plugin    -->
    <script src="assets/js/plugins/bootstrap-notify.js"></script>
    <!--  DataTables.net Plugin, full documentation here: https://datatables.net/    -->
    <!--<script src="assets/js/plugins/jquery.dataTables.min.js"></script>-->
    <script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>

    <!-- Control Center for Now Ui Dashboard: parallax effects, scripts for the example pages etc -->
    <script src="assets/js/now-ui-dashboard.js?v=1.4.0" type="text/javascript"></script>
    <script src="assets/js/plugins/sweetalert2.all.min.js"></script>
    <!-- FCS General purpose JS -->

    <script src="assets/js/plugins/moment.js"></script>
    <script src="assets/js/plugins/moment-with-locales.js"></script>
    <script src="assets/js/plugins/moment-timezone.js"></script>
    <script src="assets/js/plugins/moment-timezone-with-data-2012-2022.js"></script>
    <script src="assets/js/plugins/chartjs.min.js"></script>
    <script src="assets/js/plugins/daterangepicker.js"></script>
    <script src="assets/js/plugins/nouislider.js"></script>
    <script src="assets/js/plugins/wNumb.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/i18next/17.0.6/i18next.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-i18next/1.2.1/jquery-i18next.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/i18next-xhr-backend/3.0.0/i18nextXHRBackend.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/i18next-browser-languagedetector/3.0.1/i18nextBrowserLanguageDetector.min.js"></script>
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.0.3/nouislider.min.js"></script>-->
    <script src="assets/js/fcsjs.js?v=245"></script>
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-database.js"></script>
    <script src="fcs-pilots/EWS_Pilots_Demo.js"></script>

    <script>
        // Your web app's Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyAPzUobkAIPQhZCzwkEw70Qc_bFA7BBIYo",
            authDomain: "floodcitisense.firebaseapp.com",
            databaseURL: "https://floodcitisense.firebaseio.com",
            projectId: "floodcitisense",
            storageBucket: "floodcitisense.appspot.com",
            messagingSenderId: "526829940303",
            appId: "1:526829940303:web:a654a9f2013ad4df"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

    </script>
    <script src="http://api.ipify.org/?format=jsonp&callback=get_viewers_ip">
    </script>

    <script>
        {
            //page init
            var infoWindow, selEWSID, selEWSName, chartOfJS, selRow, selectTr;;
            var polygons = [];
            var zoomLevel = 2;
            var lastFilterLength = -1;
            var start = moment().subtract(7, 'days');
            var end = moment().subtract(1, 'days');
            //var site_prefix = 'http://118.163.199.193:14480/istsos/';
            var url = 'https://api.floodcitisense.eu/';
            var lastMapHeight = 0;
            var mapHeightPadding = 120;
            var table;
            var initSearch = false;
        }

        function langChangeAnchor(lng) {
            $('body').localize();
            $('#pageTitle').localize();
            stopAutoPlay();
            openHistryDiv(false);
            try { $('#divFooter').localize(); $('#modalAbout').localize(); } catch (ex) { };
            initNav();
            if (sessionStorage.getItem('fcs_page_views_count') != null) {
                $('#fcsCounter').html('&nbsp;' + i18next.t('sidemenu.visitors') + "：" + sessionStorage.getItem('fcs_page_views_count'));
            }
            if (table)
                table.destroy();
            table = $('#maintable').DataTable({
                'pagingType': "full_numbers",
                'lengthMenu': [[10, 15, 25, 50, -1], [10, 15, 25, 50, "All"]],
                displayLength: 15,
                responsive: true,
                scrollY: '70vh',
                select: true,
                scrollCollapse: true,
                paging: true,
                language: {
                    "sEmptyTable": i18next.t('table.sInfoEmpty'),
                    "sInfo": i18next.t('table.sInfo'),
                    "sInfoEmpty": i18next.t('table.sInfoEmpty'),
                    "sInfoFiltered": i18next.t('table.sInfoFiltered'),
                    "sInfoPostFix": i18next.t('table.sInfoPostFix'),
                    "sInfoThousands": i18next.t('table.sInfoThousands'),
                    "sLengthMenu": i18next.t('table.sLengthMenu'),
                    "sLoadingRecords": i18next.t('table.sLoadingRecords'),
                    "sProcessing": i18next.t('table.sProcessing'),
                    "sSearch": i18next.t('table.sSearch'),
                    "sZeroRecords": i18next.t('table.sZeroRecords'),
                    "oAria": {
                        "sSortAscending": i18next.t('table.oAria.sSortAscending'),
                        "sSortDescending": i18next.t('table.oAria.sSortDescending')
                    },
                    search: '_INPUT_',
                    paginate: {
                        "first": '<i class="fa fa-backward"></i>',
                        "last": '<i class="fa fa-forward"></i>',
                        "next": '<i class="fa fa-step-forward"></i>',
                        "previous": '<i class="fa fa-step-backward"></i>'
                    }
                },
                'columns': [
                    { data: 'properties.ID' },
                    { data: 'properties.NAME_NEW2' },
                    { data: null }
                ]
                ,
                'rowCallback': function (row, data, index) {
                    $('td:eq(2)', row).html(
                        '<button class="btn btn-round btn-info btn-icon btn-sm like"><i class="fas fa-map-marked-alt" data-toggle="tooltip" data-placement="bottom" title="' + i18next.t('btn.locate') + '" ></i></button>');
                }, 'columnDefs': [{
                    'targets': [2],
                    'data': null,
                    'orderable': false,
                    'defaultContent': ''
                    //+'<a href="#" class="btn btn-round btn-warning btn-icon btn-sm edit"><i class="fas fa-chart-bar"></i></a>'
                },
                ]
            });
            $('#fcsEWS').addClass('active');
            //$('#cboEwsType option[value="-1"]').html(i18next.t('sensor.filter.allReduce'));
            $('#cboEwsType option[value="rotterdam"]').html(i18next.t('ews.filter.rotterdam'));
            $('#cboEwsType option[value="brussels"]').html(i18next.t('ews.filter.brussels'));
            $('#cboEwsType option[value="birmingham"]').html(i18next.t('ews.filter.birmingham'));
            $("#cboEwsType").selectpicker('refresh');
            $("#cboEwsType").trigger("change");
            //console.log('$("#cboEwsType").trigger("change");');
            table.on('draw', function () {
                //console.log('Redraw occurred at: ' + new Date().getTime());
                $('#loading_table').hide();
            });

            table.on('click', '.btn-info', function (e) {
                stopAutoPlay();
                e.preventDefault();
                if (selectTr != null) {
                    selectTr.removeClass('selected');
                    selectTr = null;
                }
                selRow = null;
                selectTr = $(this).parents('tr');
                selectTr.addClass('selected');
                selRow = table.row($(this).parents('tr')).data();
                //map.setZoom(12);
                for (var i in polygons) {
                    if (polygons[i].cusID == selRow.properties.ID) {
                        new google.maps.event.trigger(polygons[i], 'click', {});
                        break;
                    }
                }
                return false;
            });
            adjustMapTableHeight();
        }
        function loadEWS(d) {
            $('#loading_table').show();
            //console.log('loadews');
            //var data = JSON.parse(d);
            var data = d;
            table.rows().remove();
            table.rows.add(data.features);
            table.columns.adjust().draw();
            //drawMap(data.features);
        }

        /**
        * Init Google Map and adjust Map&Table height;
        */
        function initMap() {
            $('#loading_table').show();
            mpos = { lat: 52.4419775, lng: -1.9326545 };
            map = new google.maps.Map(document.getElementById('map'), {
                mapTypeControl: false,
                center: mpos,
                zoom: 7
            });
            var contentString =
                '<span class="badge badge-warning" id="spMarker" style=""></span>'
                ;

            infoWindow = new google.maps.InfoWindow({
                content: contentString
            });
            google.maps.event.addListener(infoWindow, 'domready', function () {
                chartTitle = i18next.t('ews.map.chart.title') + ':' + selEWSName;
                $('#spMarker').text(selEWSName);
                openHistryDiv(true);
                $('#iconPlay').removeClass("fa-stop").addClass("fa-play");
                initEWSChart(chartTitle, arrEWS, 0);
            });

            google.maps.event.addListener(infoWindow, 'closeclick', function () {
                //console.log('closeevent');
                //$('#spMarker').text('');
                //stopAutoPlay();
                //window.clearInterval(timeoutID2);
            });
            map.setZoom(10);
            map.setCenter(mpos);
            loadAreaProperty();
        }

        var arrPilot;
        function loadAreaProperty() {
            arrPilot = ewsdata.pilot;
            for (var i in arrPilot) {
                var tempArea = arrPilot[i];
                if (tempArea.catchmentlayer) {
                    var areaInitFinish = (i == arrPilot.length - 1) ? true : false;
                    loadArea2SessionStorage(tempArea.abbreviation, "fcs-pilots/" + tempArea.abbreviation + "/" + tempArea.catchmentlayer, areaInitFinish);
                    for (var se in tempArea.event) {
                        tempEvent = tempArea.event[se];
                        console.log(tempEvent.displaywindow * tempEvent.displayGap);
                        //unable to preload all event Data
                        //for (var temp = 0; temp < tempEvent.displaywindow * tempEvent.displayGap; temp++) {
                        //    var fileName = moment.utc(tempEvent.starttime).add(temp * tempEvent.timeinterval, 'seconds').format('YYYYMMDDHHmmss');
                        //    var first = ((se == 0) && (temp == 0 ? true : false));
                        //    var urlStr = "fcs-pilots/" + tempArea.abbreviation + "/" + tempEvent.name + "/" + fileName + ".json";
                        //    loadEvent2SessionStorage('fcs_ews_area_prob_' + tempArea.abbreviation + "_" + tempEvent.name + "_" + fileName, urlStr, first);
                        //}
                        var fileName = moment.utc(tempEvent.starttime).format('YYYYMMDDHHmmss');
                        var urlStr = "fcs-pilots/" + tempArea.abbreviation + "/" + tempEvent.name + "/" + fileName + ".json";
                        loadEvent2SessionStorage('fcs_ews_area_prob_' + tempArea.abbreviation + "_" + tempEvent.name + "_" + fileName, urlStr, true);

                    }
                }
            }

            //setTimeout(initI18next, 1000000);
        }

        function loadArea2SessionStorage(area, urlstr, initFinish) {
            //console.log("loadArea2SessionStorage:" + area + "," + urlstr);
            var data = sessionStorage.getItem('fcs_ews_area_basic_' + area);
            if (data == null) {
                $.ajax({
                    url: urlstr,
                    "async": true,
                    "crossDomain": true,
                    //method: 'get',
                    data: {
                    },
                    contentType: 'application/json; charset=utf-8',

                    success: function (r) {
                        try {
                            //console.log("loadArea2SessionStorage=" + r.features.length);
                            if (r.features.length > 0) {
                                sessionStorage.setItem('fcs_ews_area_basic_' + area, JSON.stringify(r));
                            }
                            else {
                                $('#loading_table').hide();
                            }
                            if (initFinish)
                                initI18next();
                        }
                        catch (ex) {
                            console.log(ex);
                            $('#loading_table').hide();
                        }
                    },

                    error: function (xhr, ajaxOptions, thrownError) {
                        console.log(xhr);
                        console.log(ajaxOptions);
                        console.log(thrownError);
                        $('#loading_table').hide();
                    }
                });
            }
            else {
                if (initFinish)
                    initI18next();
            }
        }
        function loadEvent2SessionStorage(key, urlstr, f) {
            //console.log("loadEvent2SessionStorage:" + key + "," + urlstr);
            var data = sessionStorage.getItem(key);
            if (data == null) {
                $.ajax({
                    url: urlstr,
                    "async": true,
                    "crossDomain": true,
                    //method: 'get',
                    data: {
                    },
                    contentType: 'application/json; charset=utf-8',

                    success: function (r) {
                        try {
                            if (r.features.length > 0) {
                                var map = new Map();
                                for (var f in r.features) {
                                    var temp = new Object();
                                    temp.c = r.features[f].properties.color;
                                    if (f)
                                        temp.p = r.features[f].properties.prob;
                                    if (!map.has(r.features[f].properties.ID.toString()))
                                        map.set(r.features[f].properties.ID.toString(), temp);
                                }
                                sessionStorage.setItem(key, JSON.stringify(Array.from(map.entries())));
                                $('#loading_table').hide();
                            }
                            else {
                                $('#loading_table').hide();
                            }
                        }
                        catch (ex) {
                            console.log(ex);
                            $('#loading_table').hide();
                        }
                    },

                    error: function (xhr, ajaxOptions, thrownError) {
                        console.log(xhr);
                        console.log(ajaxOptions);
                        console.log(thrownError);
                        $('#loading_table').hide();
                    }
                });
            }
        }

        function checkLoadEvent() {
            //console.log("checkLoadEvent-eventCatchNum:" + eventCatchNum + ",eventCurrentCatchNum:" + eventCurrentCatchNum);
            if (eventCatchNum == eventCurrentCatchNum) {
                window.clearInterval(timeoutID2);
                //console.log("Catch finish:");
                //for (var i = 0; i < eventCatchNum; i++) {
                //    console.log(sessionStorage.getItem("fcs_p_" + i));
                //}
                arrEWS = [];
                for (var k = 0; k < selectEvent.displayGap; k++) {
                    var ewsObj = new Object();
                    ewsObj.arrLabel = new Array();
                    ewsObj.arrData = new Array();
                    ewsObj.arrBgC = new Array();
                    ewsObj.arrBC = new Array();
                    arrLabel = [];
                    arrData = [];
                    arrBgC = [];
                    arrBC = [];
                    var cr = 'rgba(30,144,255';
                    var crBgC = (cr + ', 0.2)');
                    var crBC = (cr + ', 1)');
                    for (var temp = k; temp < k + selectEvent.displaywindow; temp++) {
                        var prop = sessionStorage.getItem("fcs_p_" + temp);
                        //console.log(temp + ":" + prop);
                        if (prop != null) {
                            //console.log(selectEvent.timeinterval * k / 60 + "," + selectEvent.timeinterval * k);
                            ewsObj.arrLabel.push(selectEvent.timeinterval * (temp + 1 - k) / 60 + 'Min');
                            ewsObj.arrData.push(prop);
                            ewsObj.arrBgC.push(crBgC);
                            ewsObj.arrBC.push(crBC);
                        }
                    }
                    arrEWS.push(ewsObj);
                }
                console.log(arrEWS);
                infoWindow.setPosition({
                    lat: parseFloat(sessionStorage.getItem("ews_c_lat"), 10),
                    lng: parseFloat(sessionStorage.getItem("ews_c_lng"), 10)
                });
                // open it
                infoWindow.open(map);
            }
        }

        var eventCatchNum = 0;
        var eventCurrentCatchNum = 0;
        function loadEvent2FixSessionStorage(urlstr, ewsid, catchIdx, pos) {
            var map;
            if (catchIdx == 0) {
                for (var i = 0; i < eventCatchNum + 1; i++) {
                    sessionStorage.removeItem("fcs_p_" + i);
                }
            }

            //eventCatchNum++;
            //console.log("eventCatchNum=" + eventCatchNum + ",catchIdx=" + catchIdx);
            $.ajax({
                url: urlstr,
                "async": true,
                "crossDomain": true,
                //method: 'get',
                data: {
                },
                contentType: 'application/json; charset=utf-8',

                success: function (r) {
                    try {
                        if (r.features.length > 0) {
                            for (var f in r.features) {
                                if (ewsid == r.features[f].properties.ID.toString()) {
                                    //map.set(catchIdx, r.features[f].properties.prob);
                                    sessionStorage.setItem("fcs_p_" + catchIdx, r.features[f].properties.prob);
                                    break;
                                }
                            }
                            //console.log(sessionStorage.getItem("fcs_p_" + catchIdx));
                            eventCurrentCatchNum = catchIdx + 1;
                            //if (eventCatchNum == catchIdx + 1) {
                            //    //console.log("Catch finish:");
                            //    //for (var i = 0; i < eventCatchNum; i++) {
                            //    //    console.log(sessionStorage.getItem("fcs_p_" + i));
                            //    //}
                            //    arrEWS = [];
                            //    for (var k = 0; k < selectEvent.displayGap; k++) {
                            //        var ewsObj = new Object();
                            //        ewsObj.arrLabel = new Array();
                            //        ewsObj.arrData = new Array();
                            //        ewsObj.arrBgC = new Array();
                            //        ewsObj.arrBC = new Array();
                            //        arrLabel = [];
                            //        arrData = [];
                            //        arrBgC = [];
                            //        arrBC = [];
                            //        var cr = 'rgba(30,144,255';
                            //        var crBgC = (cr + ', 0.2)');
                            //        var crBC = (cr + ', 1)');
                            //        for (var temp = k; temp < k + selectEvent.displaywindow; temp++) {
                            //            var prop = sessionStorage.getItem("fcs_p_" + temp);
                            //            //console.log(temp + ":" + prop);
                            //            if (prop != null) {
                            //                ewsObj.arrLabel.push(selectEvent.timeinterval / 60 + 'Min');
                            //                ewsObj.arrData.push(prop);
                            //                ewsObj.arrBgC.push(crBgC);
                            //                ewsObj.arrBC.push(crBC);
                            //            }
                            //        }
                            //        arrEWS.push(ewsObj);
                            //    }
                            //    console.log(arrEWS);
                            //    infoWindow.setPosition(pos);
                            //    // open it
                            //    console.log("open it "+pos);
                            //    infoWindow.open(map);
                            //    console.log("open it 2");
                            //}

                            //$('#loading_table').hide();
                        }
                        else {
                            $('#loading_table').hide();
                        }
                    }
                    catch (ex) {
                        console.log(ex);
                        $('#loading_table').hide();
                    }
                },

                error: function (xhr, ajaxOptions, thrownError) {
                    console.log(xhr);
                    console.log(ajaxOptions);
                    console.log(thrownError);
                    $('#loading_table').hide();
                }
            });
        }

        function loadArea(area, urlstr) {
            //console.log('loadarea:' + area)
            $('#loading_table').show();
            var data = sessionStorage.getItem('fcs_ews_area_basic_' + area);
            if (data != null) {
                loadEWS(JSON.parse(data));
            }
            //else {
            //    $.ajax({
            //        url: urlstr,
            //        "async": true,
            //        "crossDomain": true,
            //        //method: 'get',
            //        data: {
            //        },
            //        contentType: 'application/json; charset=utf-8',

            //        success: function (r) {
            //            try {
            //                console.log("loadArea=" + r.features.length);
            //                if (r.features.length > 0) {
            //                    sessionStorage.setItem('fcs_ews_area_basic_' + area, JSON.stringify(r));
            //                    loadEWS(r);
            //                }
            //                else {
            //                    $('#loading_table').hide();
            //                }
            //            }
            //            catch (ex) {
            //                console.log(ex);
            //                $('#loading_table').hide();
            //            }
            //        },

            //        error: function (xhr, ajaxOptions, thrownError) {
            //            console.log(xhr);
            //            console.log(ajaxOptions);
            //            console.log(thrownError);
            //            $('#loading_table').hide();
            //        }
            //    });
            //}
        }

        function updateMapColor(oMap) {
            console.log("updateMapColor0:" + new Date().getTime());
            //console.log(oMap);
            //console.log(table.rows().data());
            $('#loading_table').show();
            deletePolygon();
            table.rows().every(function (rowIdx, tableLoop, rowLoop) {
                var data = this.data();
                var key = data.properties.ID.toString();
                if (oMap.has(key)) {
                    //console.log(key + ":" + data.properties.color + " , " + oMap.get(key).c);
                    data.properties.color = oMap.get(key).c;
                }
            });
            //console.log("updateMapColor2:" + new Date().getTime());
            drawMap(table.rows().data());
            if (selectTr != null) {
                selectTr.removeClass('selected');
                selectTr = null;
            }
            //console.log("updateMapColor3:" + new Date().getTime());
            selRow = null;
            infoWindow.close();
            $('#loading_table').hide();
        }

        function loadEvent(key, urlstr, updateColor) {
            //console.log('loadEvent:' + key + "," + urlstr + "," + updateColor);
            var data = sessionStorage.getItem(key);
            if (data != null) {
                if (updateColor) {
                    $('#loading_table').show();
                    updateMapColor(new Map(JSON.parse(data)));
                }

            }
        }
        var selectArea = null;
        var selectEvent = null;

        function openHistryDiv(v) {
            if (v) {
                $('#histryDiv').removeClass('d-none');
            }
            else {
                $('#histryDiv').addClass('d-none');
                stopAutoPlay();
            }
        }

        $(document).ready(function () {
            $('#fcsFooter').load("FCSFooter.html", function () {
                try { $('#divFooter').localize(); } catch (ex) { };
            });
            $('#fcsAbout').load("FCSAbout.html", function () {
                try { $('#modalAbout').localize(); } catch (ex) { };
            });

            $('[data-toggle="tooltip"]').tooltip();

            $(window).resize(function () {
                if (this.resizeTO) clearTimeout(this.resizeTO);
                this.resizeTO = setTimeout(function () {
                    adjustMapTableHeight();
                }, 200);
            });

            $('.fixed-plugin a').click(function (event) {
                if ($(this).hasClass('switch-trigger')) {
                    if (event.stopPropagation) {
                        event.stopPropagation();
                    }
                    else if (window.event) {
                        window.event.cancelBubble = true;
                    }
                }
            });

            $('input[type=radio][name=maptypeRadios]').change(function () {
                //alert(this.value);hybrid
                map.setMapTypeId(this.value);
            });
            $("input[type=radio][name=maptypeRadios][value='roadmap']").prop("checked", true);

            $('#cboEwsType').on('change', function (e) {
                e.preventDefault();
                stopAutoPlay();
                openHistryDiv(false);
                $('#loading_table').show();
                $('#cboEwsEvent').empty();
                selectArea = null;
                selectEvent = null;
                //console.log('cboEwsType change');

                for (var i in arrPilot) {
                    //console.log(arrPilot[i]);
                    if (arrPilot[i].name.toLowerCase() == $('#cboEwsType').val().toLowerCase()) {
                        selectArea = arrPilot[i];
                        break;
                    }
                }

                if (selectArea) {
                    if (selectArea.event.length > 0) {
                        for (var i in selectArea.event) {
                            $('#cboEwsEvent').append(
                                $('<option>').attr('value', selectArea.event[i].name).html(selectArea.event[i].name)
                            )
                            $("#cboEwsEvent").selectpicker('refresh');
                        }
                        loadArea(selectArea.abbreviation, "fcs-pilots/" + selectArea.abbreviation + "/" + selectArea.catchmentlayer);
                        //for (var se in selectArea.event) {
                        //    tempEvent = selectArea.event[se];
                        //    for (var temp = 0; temp < tempEvent.displaywindow * (tempEvent.displayGap + 1); temp++) {
                        //        var fileName = moment.utc(tempEvent.starttime).add(temp * tempEvent.timeinterval, 'seconds').format('YYYYMMDDHHmmss');
                        //        var first = ((se == 0) && (temp == 0 ? true : false));
                        //        var urlStr = "fcs-pilots/" + selectArea.abbreviation + "/" + tempEvent.name + "/" + fileName + ".json";
                        //        //console.log(se + "," + first + ":" + ((se == 0) && first));
                        //        loadEvent('fcs_ews_area_prob_' + selectArea.abbreviation + "_" + tempEvent.name + "_" + fileName, urlStr, first);
                        //        if (first)
                        //            selectEvent = tempEvent;
                        //    }
                        //}
                        tempEvent = selectArea.event[0];
                        var fileName = moment.utc(tempEvent.starttime).format('YYYYMMDDHHmmss');
                        var urlStr = "fcs-pilots/" + selectArea.abbreviation + "/" + tempEvent.name + "/" + fileName + ".json";
                        loadEvent('fcs_ews_area_prob_' + selectArea.abbreviation + "_" + tempEvent.name + "_" + fileName, urlStr, true);
                        selectEvent = tempEvent;

                    }
                    else {
                        table.rows().remove();
                        table.columns.adjust().draw();
                        $("#cboEwsEvent").selectpicker('refresh');
                        $('#loading_table').hide();
                    }
                }
                else {
                    //jon no match data
                    table.rows().remove();
                    table.columns.adjust().draw();
                    $("#cboEwsEvent").selectpicker('refresh');
                    $('#loading_table').hide();
                }
                if (!initSearch) {
                    initSearch = true;
                    
                    initTableSearchEvent();
                }
                deletePolygon();
                drawMap(table.rows().data());
                //if ($('#cboEwsType').val() == '0' || $('#cboEwsType').val() == '-1') {
                //    table.columns().search('').draw();
                //}
                //else {
                //    table.columns(3).search($('#cboEwsType').val())
                //        .draw();
                //}
                return false;
            });
            $('#cboEwsEvent').on('change', function (e) {
                e.preventDefault();
                stopAutoPlay();
                openHistryDiv(false);
                if ($('#cboEwsEvent').val()) {
                    if (selectArea) {
                        if (selectArea.event.length > 0) {
                            for (var i in selectArea.event) {
                                if (selectArea.event[i].name.toLowerCase() == $('#cboEwsEvent').val().toLowerCase()) {
                                    selectEvent = selectArea.event[i];
                                    break;
                                }
                            }
                        }

                        if (selectEvent) {
                            var fileName = moment.utc(selectEvent.starttime).add(0 * selectEvent.timeinterval, 'seconds').format('YYYYMMDDHHmmss');
                            console.log(fileName);
                            var urlStr = "fcs-pilots/" + selectArea.abbreviation + "/" + selectEvent.name + "/" + fileName + ".json";
                            loadEvent('fcs_ews_area_prob_' + selectArea.abbreviation + "_" + selectEvent.name + "_" + fileName, urlStr, true);
                        }
                    }
                }
                else {
                    console.log('need to clear list and map');
                }
                return false;
            });

        });

        //$.fn.dataTable.ext.search.push(
        //    function (settings, data, dataIndex) {
        //        var sel = true;
        //        if ($('#cboEwsType').val() == '-1') {
        //            if (data[3] == 'na') {
        //                sel = false;
        //            }
        //        }
        //        return sel;
        //    }
        //);
        function initTableSearchEvent() {
            table.on('search.dt', function () {
                console.log("table on search");
                if (lastFilterLength != table.rows({ filter: 'applied' }).nodes().length) {
                    $('#loading_table').show();
                    
                    lastFilterLength = table.rows({ filter: 'applied' }).nodes().length;
                    
                    if (selectTr != null) {
                        selectTr.removeClass('selected');
                        selectTr = null;
                    }
                    selRow = null;
                    infoWindow.close();
                    $('#loading_table').hide();
                }
            });
        }
        var chartTitle;
        var arrEWS = new Array();
        var currentEwsIdx = 0;
        var timeoutID2;
        function drawMap(data) {
            //map.setCenter({ lat: 50.7949293, lng: 4.40799992 });
            polygons = [];
            for (var i = 0; i < data.length; i++) {
                var r = data[i];
                var ewsPolygon, ewsPaths;
                if (r.geometry.type.toLowerCase() == 'multipolygon') {
                    for (var j = 0; j < r.geometry.coordinates.length; j++) {

                        if (r.geometry.coordinates[j].length == 1) {
                            ewsPaths = trans2Arr(r.geometry.coordinates[j][0]);
                        }
                        else {
                            var arr = new Array();
                            for (var k = 0; k < r.geometry.coordinates[j].length; k++) {
                                arr.push(trans2Arr(r.geometry.coordinates[j][k]));
                            }
                            ewsPaths = arr;
                        }

                    }
                }
                else if (r.geometry.type.toLowerCase() == 'polygon') {
                    ewsPaths = trans2Arr(r.geometry.coordinates[0]);
                    //console.log(r.geometry.coordinates[0]);
                    //var arr = new Array();
                    //for (var k = 0; k < r.geometry.coordinates[0].length; k++) {
                    //    arr.push(trans2Arr(r.geometry.coordinates[0][k]));
                    //}
                    //ewsPaths = arr;
                }
                if (ewsPaths != null) {

                    ewsPolygon = new google.maps.Polygon({
                        paths: ewsPaths,
                        strokeColor: '#FF0000',
                        strokeOpacity: 0.8,
                        strokeWeight: 0.5,
                        fillColor: r.properties.color,
                        fillOpacity: 0.35,
                        cusID: r.properties.ID,
                        cusName: r.properties.NAME_NEW2,
                        cusXaxis: '',
                        cusYaxis: ''
                    });
                    var bounds = new google.maps.LatLngBounds();
                    for (var pathidx = 0; pathidx < ewsPolygon.getPath().getLength(); pathidx++) {
                        bounds.extend(ewsPolygon.getPath().getAt(pathidx));
                    }

                    ewsPolygon.center = bounds.getCenter();
                    ewsPolygon.setMap(map);
                    ewsPolygon.addListener('click', (function (content) {
                        return function () {
                            stopAutoPlay();
                            selEWSID = this.cusID;
                            selEWSName = this.cusName;
                            console.log(selEWSID);
                            window.clearInterval(timeoutID2);
                            arrEWS = [];
                            if (selectArea && selectEvent) {
                                //console.log(this.center);
                                //console.log(this.center.lat());
                                //console.log(this.center.lng());
                                sessionStorage.setItem("ews_c_lat", this.center.lat());
                                sessionStorage.setItem("ews_c_lng", this.center.lng());
                                eventCatchNum = selectEvent.displaywindow + selectEvent.displayGap;
                                eventCurrentCatchNum = 0;
                                for (k = 0; k < selectEvent.displaywindow + selectEvent.displayGap; k++) {
                                    var fileName = moment.utc(selectEvent.starttime).add(k * selectEvent.timeinterval, 'seconds').format('YYYYMMDDHHmmss');
                                    var urlStr = "fcs-pilots/" + selectArea.abbreviation + "/" + selectEvent.name + "/" + fileName + ".json";
                                    loadEvent2FixSessionStorage(urlStr, selEWSID, k, this.center);
                                }
                                timeoutID2 = window.setInterval((() => checkLoadEvent()), 1 * 300);
                                //for (var k = 0; k < selectEvent.displayGap; k++) {
                                //    var ewsObj = new Object();
                                //    ewsObj.arrLabel = new Array();
                                //    ewsObj.arrData = new Array();
                                //    ewsObj.arrBgC = new Array();
                                //    ewsObj.arrBC = new Array();
                                //    arrLabel = [];
                                //    arrData = [];
                                //    arrBgC = [];
                                //    arrBC = [];
                                //    var cr = 'rgba(30,144,255';
                                //    var crBgC = (cr + ', 0.2)');
                                //    var crBC = (cr + ', 1)');
                                //    for (var temp = k; temp < k + selectEvent.displaywindow; temp++) {
                                //        var fileName = moment.utc(selectEvent.starttime).add(temp * selectEvent.timeinterval, 'seconds').format('YYYYMMDDHHmmss');
                                //        var urlStr = "fcs-pilots/" + selectArea.abbreviation + "/" + selectEvent.name + "/" + fileName + ".json";
                                //        var seKey = 'fcs_ews_area_prob_' + selectArea.abbreviation + "_" + selectEvent.name + "_" + fileName;
                                //        var data = sessionStorage.getItem(seKey);

                                //        if (data != null) {
                                //            var seMap = new Map(JSON.parse(data));
                                //            ewsObj.arrLabel.push(selectEvent.timeinterval / 60 + 'Min');
                                //            ewsObj.arrData.push(seMap.get(selEWSID.toString()).p);
                                //            ewsObj.arrBgC.push(crBgC);
                                //            ewsObj.arrBC.push(crBC);
                                //        } else {
                                //            console.log(urlStr);
                                //        }
                                //    }
                                //    arrEWS.push(ewsObj);
                                //    //var fileName = moment.utc(selectEvent.starttime).add(temp * selectEvent.timeinterval, 'seconds').format('YYYYMMDDHHmmss');
                                //    //var seKey = 'fcs_ews_area_prob_' + selectArea.abbreviation + "_" + tempEvent.name + "_" + fileName;
                                //}
                                //console.log(arrEWS);
                                //infoWindow.setPosition(this.center);
                                //// open it
                                //infoWindow.open(map);
                            }
                            //if (selectArea && selectEvent) {
                            //    for (var k = 0; k < selectEvent.displayGap; k++) {
                            //        var ewsObj = new Object();
                            //        ewsObj.arrLabel = new Array();
                            //        ewsObj.arrData = new Array();
                            //        ewsObj.arrBgC = new Array();
                            //        ewsObj.arrBC = new Array();
                            //        arrLabel = [];
                            //        arrData = [];
                            //        arrBgC = [];
                            //        arrBC = [];
                            //        var cr = 'rgba(30,144,255';
                            //        var crBgC = (cr + ', 0.2)');
                            //        var crBC = (cr + ', 1)');
                            //        for (var temp = k; temp < k + selectEvent.displaywindow; temp++) {
                            //            var fileName = moment.utc(selectEvent.starttime).add(temp * selectEvent.timeinterval, 'seconds').format('YYYYMMDDHHmmss');
                            //            var urlStr = "fcs-pilots/" + selectArea.abbreviation + "/" + selectEvent.name + "/" + fileName + ".json";
                            //            var seKey = 'fcs_ews_area_prob_' + selectArea.abbreviation + "_" + selectEvent.name + "_" + fileName;
                            //            var data = sessionStorage.getItem(seKey);

                            //            if (data != null) {
                            //                var seMap = new Map(JSON.parse(data));
                            //                ewsObj.arrLabel.push(selectEvent.timeinterval / 60 + 'Min');
                            //                ewsObj.arrData.push(seMap.get(selEWSID.toString()).p);
                            //                ewsObj.arrBgC.push(crBgC);
                            //                ewsObj.arrBC.push(crBC);
                            //            } else {
                            //                console.log(urlStr);
                            //            }
                            //        }
                            //        arrEWS.push(ewsObj);
                            //        //var fileName = moment.utc(selectEvent.starttime).add(temp * selectEvent.timeinterval, 'seconds').format('YYYYMMDDHHmmss');
                            //        //var seKey = 'fcs_ews_area_prob_' + selectArea.abbreviation + "_" + tempEvent.name + "_" + fileName;
                            //    }
                            //    console.log(arrEWS);
                            //    infoWindow.setPosition(this.center);
                            //    // open it
                            //    infoWindow.open(map);
                            //}
                            console.log(selectEvent);
                            //var temp = Math.round(Math.random() * 50);
                            //if (temp == 0) { temp = 1; }
                            ////if (temp > 10) {
                            ////    temp = 10;
                            ////}
                            ////else {
                            ////    temp = 1;
                            ////}
                            //console.log('temp=' + temp);
                            //for (var k = 0; k < temp; k++) {
                            //    var ewsObj = new Object();
                            //    ewsObj.arrLabel = new Array();
                            //    ewsObj.arrData = new Array();
                            //    ewsObj.arrBgC = new Array();
                            //    ewsObj.arrBC = new Array();
                            //    arrLabel = [];
                            //    arrData = [];
                            //    arrBgC = [];
                            //    arrBC = [];
                            //    var cr = 'rgba(30,144,255';
                            //    var crBgC = (cr + ', 0.2)');
                            //    var crBC = (cr + ', 1)');
                            //    for (var t = 1; t < 24; t++) {
                            //        ewsObj.arrLabel.push(t + 'Hr');
                            //        ewsObj.arrData.push(Math.random());
                            //        ewsObj.arrBgC.push(crBgC);
                            //        ewsObj.arrBC.push(crBC);
                            //    }
                            //    arrEWS.push(ewsObj);
                            //}

                            //infoWindow.setPosition(this.center);
                            //// open it
                            //infoWindow.open(map);
                            var tempRow = null;
                            var tempRr = null;
                            var tempIdx = -1;
                            //console.log(table.rows({filter: 'applied' }).nodes().length + ',' + table.rows({filter: 'applied' }).data().length);
                            for (var i in table.rows().data()) {
                                if (this.cusID == table.rows().data()[i].properties.ID) {
                                    tempRow = table.rows().data()[i];
                                    tempRr = table.rows().nodes()[i];
                                    tempIdx = i;
                                    break;
                                }
                            }

                            if (selRow != tempRow) {
                                if (selectTr != null) {
                                    selectTr.removeClass('selected');
                                    selectTr = null;
                                }
                                selRow = null;
                                selRow = tempRow;
                                selectTr = $(tempRr);
                                $(tempRr).addClass('selected');
                                if (table.page.info().length != -1 && tempIdx != -1) {
                                    var pageIdx = parseInt(tempIdx / table.page.info().length, 10);
                                    table.page(pageIdx).draw('page');
                                }
                            }
                        }
                    })(''));
                    polygons.push(ewsPolygon);
                }
            }
            //map.setZoom(12);
            //console.log("drawmap");
        }

        function trans2Arr(d) {
            var arr = new Array();
            for (i in d) {
                arr.push({ lat: d[i][1], lng: d[i][0] });
            }

            return arr;
        }

        function setMapOnAll(map) {
            for (var i = 0; i < polygons.length; i++) {
                polygons[i].setMap(map);
            }
        }

        // Removes the markers from the map, but keeps them in the array.
        function clearMarkers() {
            setMapOnAll(null);
        }

        function deletePolygon() {
            clearMarkers();
            polygons = [];
        }

        /**
        * Adjust Map&Table Height when windows resize
        */
        function adjustMapTableHeight() {
            if (table) {
                var h = Math.max(document.documentElement.clientHeight, window.innerHeight || 0) - mapHeightPadding;
                if (lastMapHeight != h) {
                    h = h < 600 ? 600 : h;
                    lastMapHeight = h;

                    $('#map').css("height", lastMapHeight + "px");
                    $('.dataTables_scrollBody').css('height', (lastMapHeight - $('#fcsTableHeader').height - $('#fcsTableToolbar').height) + "px");
                    table.draw();
                }
            }
        }

        function clearChart() {
            if (chartOfJS != null || chartOfJS == 'undefined') {
                chartOfJS.destroy();
                console.log("destroy");
            }
        }

        var playPro = false;
        var timeoutID;
        function playProbability() {
            if (!playPro) {
                if (currentEwsIdx == arrEWS.length - 1) {
                    currentEwsIdx = 0;
                }
                $('#iconPlay').removeClass("fa-play").addClass("fa-stop");
                playPro = true;
                timeoutID = window.setInterval((() => startPlay()), 1 * 1500);
            }
            else {
                $('#iconPlay').removeClass("fa-stop").addClass("fa-play");
                window.clearInterval(timeoutID);
                playPro = false;
            }
        }

        function stopAutoPlay() {
            //console.log('stopAutoPlay' + playPro);
            if (playPro) {
                $('#iconPlay').removeClass("fa-stop").addClass("fa-play");
                window.clearInterval(timeoutID);
                playPro = false;
            }
        }

        function startPlay() {
            //console.log('startPlay:' + currentEwsIdx);
            updateProbability(true);
            if (currentEwsIdx == arrEWS.length - 1) {
                stopAutoPlay();
            }
        }
        window.onbeforeunload = function () {
            window.clearInterval(timeoutID);
            window.clearInterval(timeoutID2);
        }

        function goNext() {
            stopAutoPlay();
            updateProbability(true);
        }

        function goBack() {
            stopAutoPlay();
            updateProbability(false);
        }

        function updateProbability(next) {
            if (slider != null) {
                if (next) {
                    if (currentEwsIdx != arrEWS.length - 1) {
                        currentEwsIdx++;
                        slider.noUiSlider.updateOptions({
                            start: currentEwsIdx + 1,
                        });
                        initEWSChart(chartTitle, arrEWS, currentEwsIdx);
                    }
                    //currentEwsIdx = currentEwsIdx != arrEWS.length - 1 ? currentEwsIdx + 1 : arrEWS.length - 1;
                }
                else {
                    if (currentEwsIdx != 0) {
                        currentEwsIdx--;
                        slider.noUiSlider.updateOptions({
                            start: currentEwsIdx + 1,
                        });
                        initEWSChart(chartTitle, arrEWS, currentEwsIdx);
                    }
                    //currentEwsIdx = currentEwsIdx != 0 ? currentEwsIdx - 1 : 0;
                }
            }
        }

        var slider;
        function initSlider() {
            if (slider == null) {
                if (arrEWS.length != 1) {
                    slider = document.getElementById('sliderRegularNew');
                    //slider = document.getElementById('sliderRegularNew');
                    noUiSlider.create(slider, {
                        step: 1,
                        start: currentEwsIdx + 1,
                        tooltips: true,
                        connect: true,
                        range: {
                            min: 1,
                            max: arrEWS.length
                        },
                        format: wNumb({
                            decimals: 0
                        }),
                        pips: {
                            //mode: 'steps',
                            //stepped: true,
                            //density: 4
                            mode: 'count',
                            values: 10,
                            density: 4,
                            stepped: true
                        }
                    });
                    slider.noUiSlider.on('change', function (values, handle) {
                        //console.log(values[handle]);
                        currentEwsIdx = values[handle] - 1;
                        initEWSChart(chartTitle, arrEWS, currentEwsIdx);
                    });
                    setSliderVisiable(true);
                }
                else {
                    setSliderVisiable(false);
                }
            }
            else {
                if (arrEWS.length == 1) {
                    setSliderVisiable(false);
                }
                else {
                    slider.noUiSlider.updateOptions({
                        start: currentEwsIdx + 1,
                        range: {
                            min: 1,
                            max: arrEWS.length
                        },
                    });
                    setSliderVisiable(true);
                }
            }
        }

        function setSliderVisiable(t) {
            //console.log(t + ",hasClass(invisible)=" + $('#btnPlay').hasClass('invisible'));
            if (t) {
                if ($('#btnPlay').hasClass('invisible')) {
                    $('#btnPlay,#btnBack,#btnNext,#sliderRegular').addClass('visible').removeClass('invisible');
                }
            }
            else {
                if ($('#btnPlay').hasClass('visible')) {
                    $('#btnPlay,#btnBack,#btnNext,#sliderRegular').addClass('invisible').removeClass('visible');
                }


            }
        }

        function initEWSChart(charTitle, arr, idx) {
            //clearChart();
            if (idx < 0) { idx = 0; }
            if (idx >= arr.length) { idx = arr.length - 1; }
            currentEwsIdx = idx;
            initSlider();
            var ctx = document.getElementById("chartZoneNew");
            const context = ctx.getContext('2d');
            context.clearRect(0, 0, ctx.width, ctx.height);
            //ctx.height = 200;
            //console.log($("#chartZoneNew"));
            chartOfJS = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: arr[idx].arrLabel,
                    datasets: [{
                        label: charTitle,
                        data: arr[idx].arrData,
                        backgroundColor: arr[idx].arrBgC,
                        borderColor: arr[idx].arrBC,
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    },
                    animation: {
                        duration: 0
                    }
                }
            });
        }
    </script>
    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCZvwaIH10Bf51PUyUdd7oSuaVwB0EGeq4&callback=initMap">

    </script>
</body>
</html>
